<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="bpmodels">
<title>Theoretical background for bpmodels • bpmodels</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Theoretical background for bpmodels">
<meta property="og:description" content="bpmodels">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ471458FQ"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XZ471458FQ');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark" data-bs-theme="dark"><div class="container">
    <a href="https://epiverse-trace.github.io/" class="external-link"><img src="https://epiverse-trace.github.io/blueprints/logo_white.svg" id="logo" alt="Epiverse-TRACE"></a>
    <a class="navbar-brand me-2" href="../index.html">bpmodels</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.3.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/bpmodels.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Theory &amp; literature</h6>
    <a class="dropdown-item" href="../articles/theoretical_background.html">Theoretical background for bpmodels</a>
    <a class="dropdown-item" href="../articles/branching_process_literature.html">Literature on branching process applications</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Modelling</h6>
    <a class="dropdown-item" href="../articles/projecting_incidence.html">Projecting infectious disease incidence: a COVID-19 example</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/epiverse-trace/bpmodels/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Theoretical background for bpmodels</h1>
                        <h4 data-toc-skip class="author">Sebastian Funk and James Azam</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epiverse-trace/bpmodels/blob/HEAD/vignettes/theoretical_background.Rmd" class="external-link"><code>vignettes/theoretical_background.Rmd</code></a></small>
      <div class="d-none name"><code>theoretical_background.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a>
</h2>
<blockquote>
<p><a href="https://github.com/epiverse-trace/bpmodels" class="external-link">bpmodels</a> is now <em>retired and will no longer be maintained</em>. We recommend using <a href="https://github.com/epiverse-trace/epichains" class="external-link"><code>{epichains}</code></a> instead. If you need help converting your code to use <code>{epichains}</code>, please <a href="https://github.com/epiverse-trace/epichains/discussions" class="external-link">open a discussion on epichains</a>.</p>
</blockquote>
<p><em>bpmodels</em> provides methods to analyse and simulate the size and length of branching processes with an arbitrary offspring distribution.
In this vignette we lay out the mathematical concepts behind the functionality available
in the package.</p>
</div>
<div class="section level2">
<h2 id="branching-processes">Branching processes<a class="anchor" aria-label="anchor" href="#branching-processes"></a>
</h2>
<p><a href="https://en.wikipedia.org/wiki/Branching_process" class="external-link">Branching processes</a> are a class of models that are used to model the growth of populations. They assume that each member of the population produces a number of offspring, <span class="math inline">\(Z\)</span>, that is a random variable with probability mass function <span class="math inline">\(p(Z = z | \theta)\)</span>, called the <em>offspring distribution</em>.
Their use has a long history in epidemiology, where the population is interpreted as a pathogen, and the offspring as new hosts that it infects <span class="citation">(<a href="#ref-farrington2003">Farrington, Kanaan, and Gay 2003</a>)</span>.
Below we will call these infected individuals <em>cases</em> but the methods could be applied in other contexts where branching processes are to be used.</p>
</div>
<div class="section level2">
<h2 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h2>
<p>To simulate from a branching process, we start with a single case and proceed in discrete steps or generations, drawing from the offspring distribution <span class="math inline">\(p(Z=z | \theta)\)</span> to generate new cases from each case.</p>
<p>Given an infector <span class="math inline">\(i\)</span> and infectee <span class="math inline">\(j\)</span>, we can additionally assign them a distribution of times <span class="math inline">\(T\)</span> that approximates when the infection event occurred. If we define <span class="math inline">\(T\)</span> as a random variable with distribution <span class="math inline">\(f(T = t; \theta)\)</span> we can assign each case <span class="math inline">\(j\)</span> a time <span class="math inline">\(t_{j}\)</span> which, if case <span class="math inline">\(j\)</span> has been affected by case <span class="math inline">\(i\)</span> is given by <span class="math inline">\(f(t_{j} - t_{i} | \theta)\)</span>.
If we identify the timing of cases by the time of their symptom onset this is the <a href="https://en.wikipedia.org/wiki/Serial_interval" class="external-link">serial interval</a>, but depending on case definitions this could be another interval.</p>
<div class="section level3">
<h3 id="summary-statistics">Summary statistics<a class="anchor" aria-label="anchor" href="#summary-statistics"></a>
</h3>
<p>Branching process simulations end when they have gone extinct, that is, no more offspring are being produced, or because of some stopping criterion. To summarise the simulations, we either study the <em>size</em> or <em>length</em> of the resulting <em>chain</em> of cases.
The size <span class="math inline">\(S\)</span> of a chain is the number of cases that have occurred over the course of the simulation including the initial case so that <span class="math inline">\(S \geq 1\)</span>.
The length <span class="math inline">\(L\)</span> of a chain is the number of generations that have been simulated including the initial case so that <span class="math inline">\(L \geq 1\)</span>.</p>
</div>
</div>
<div class="section level2">
<h2 id="inference">Inference<a class="anchor" aria-label="anchor" href="#inference"></a>
</h2>
<p>By characterising a chains of cases by their size of length we can conduct inference to learn about the underlying parameters <span class="math inline">\(\theta\)</span> from observation of chain sizes or chain lengths <span class="citation">(<a href="#ref-blumberg2013">Blumberg and Lloyd-Smith 2013</a>)</span>.
In general this is only possible for <em>subcritical</em> branching processes, i.e. ones where the mean number of offspring is less than 1, as otherwise the branching process could grow forever.
However, we can expand the theory to <em>supercritical</em> branching processes, i.e. ones where the mean number of offspring is greater than 1, by defining a cutoff of chain size or length beyond which we treat the chain as if it had infinite size or length, respectively.</p>
<div class="section level3">
<h3 id="size-and-length-distributions-for-some-offspring-distributions">Size and length distributions for some offspring distributions<a class="anchor" aria-label="anchor" href="#size-and-length-distributions-for-some-offspring-distributions"></a>
</h3>
<p>We show the equations for the size and length distributions for some offspring distributions where they can be derived analytically:
<a href="https://en.wikipedia.org/wiki/Poisson_distribution" class="external-link">Poisson</a>,
<a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution" class="external-link">negative binomial</a>,
<a href="https://en.wikipedia.org/wiki/Geometric_distribution" class="external-link">geometric</a>,
and a <a href="https://en.wikipedia.org/wiki/Gamma_distribution" class="external-link">gamma</a>-<a href="https://en.wikipedia.org/wiki/Borel_distribution" class="external-link">Borel</a> mixture.</p>
<div class="section level4">
<h4 id="negative-binomial-and-special-cases">Negative binomial and special cases<a class="anchor" aria-label="anchor" href="#negative-binomial-and-special-cases"></a>
</h4>
<p>If the offspring distribution is a Poisson distribution, we can interpret its rate parameter <span class="math inline">\(\lambda\)</span> as the basic reproduction number <span class="math inline">\(R_{0}\)</span> of the pathogen.
In the more general case where the offspring definition can be <em>overdispersed</em> leading to <em>superspreading</em> we can use a negative binomial offspring distribution with mean <span class="math inline">\(\mu\)</span> and overdispersion <span class="math inline">\(k\)</span> <span class="citation">Blumberg and Lloyd-Smith (<a href="#ref-blumberg2013">2013</a>)</span>.
In that case, the mean parameter <span class="math inline">\(\mu\)</span> is interpreted as the basic reproduction number <span class="math inline">\(R_0\)</span> of the pathogen.
The negative binomial distribution arises from a Poisson-gamma mixture and thus a branching process with negative binomial distributed offspring can be interpreted as one with Poisson distributed offspring where the basic reproduction number <span class="math inline">\(R_0\)</span> itself varies according to a gamma distribution.
The amount of variation in <span class="math inline">\(R_0\)</span> is then interpreted as individual-level variation in transmission representing overdispersion or superspreading, and the degree to which this happens is given by the overdispersion parameter <span class="math inline">\(k\)</span>.</p>
<div class="section level5">
<h5 id="size-distributions">Size distributions<a class="anchor" aria-label="anchor" href="#size-distributions"></a>
</h5>
<p>The probability <span class="math inline">\(p\)</span> of a chain of size <span class="math inline">\(S\)</span> given <span class="math inline">\(R_0\)</span> and <span class="math inline">\(k\)</span> in a branching process with negative binomial offspring distribution is given in Eq. 9 of <span class="citation">Blumberg and Lloyd-Smith (<a href="#ref-blumberg2013">2013</a>)</span></p>
<p><span class="math display">\[
p(S|R_0, k) = \frac{\Gamma(kS + S - 1)}{\Gamma(kS)\Gamma(S + 1)} \frac{\left(\frac{R_0}{k}\right)^{S - 1}}{\left( 1 + \frac{R_0}{k} \right)^{kS + S - 1}}
\]</span></p>
<p>where <span class="math inline">\(\Gamma\)</span> is the gamma function.
In order to estimate <span class="math inline">\(S\)</span> from a given <span class="math inline">\(R_0\)</span> and <span class="math inline">\(k\)</span> we can define a likelihood function <span class="math inline">\(L(S) = p(S|R_0, k)\)</span>.
The corresponding log-likelihood is</p>
<p><span class="math display">\[\begin{align}
\mathrm{LL}(S) = &amp;\log\Gamma(kS + S  - 1) - \left(\log\Gamma(kS) + \log\Gamma(S - 1) \right) \\
&amp; + (S-1) \log \frac{R_0}{k} - (SR_0 + (S - 1)) \log \left(1 + \frac{R_0}{k}\right)
\end{align}\]</span></p>
<p>The log-likelihood for Poisson distributed offspring follows from this where <span class="math inline">\(k\)</span> tends to infinity (corresponding to Eq. 2.2 in <span class="citation">Farrington, Kanaan, and Gay (<a href="#ref-farrington2003">2003</a>)</span>)</p>
<p><span class="math display">\[
\mathrm{LL}(S) = (S - 1) \log R_0 - S R_0 + (S - 2) \log S - \log\Gamma(S)
\]</span></p>
<p>In all cases the point estimate for the basic reproduction number <span class="math inline">\(\hat{R_0}\)</span> is related to the mean chain size <span class="math inline">\(\bar{S}\)</span> by</p>
<p><span class="math display">\[
\hat{R_0} = 1 - \frac{1}{\bar{S}}
\]</span></p>
</div>
<div class="section level5">
<h5 id="length-distributions">Length distributions<a class="anchor" aria-label="anchor" href="#length-distributions"></a>
</h5>
<p>The cumulative mass function <span class="math inline">\(F(L)\)</span> of observing a chain of length <span class="math inline">\(L\)</span> when offspring is Poisson distributed is given by Eq. (2.5) in <span class="citation">Farrington, Kanaan, and Gay (<a href="#ref-farrington2003">2003</a>)</span> (there called “outbreak duration”):</p>
<p><span class="math display">\[
F(L) = e^{-R_0} E_L \left( e^{R_0 e^{-R_0} } \right)
\]</span></p>
<p>where <span class="math inline">\(E_L(x)\)</span> is the iterated exponential function, <span class="math inline">\(E_0(x) = 1\)</span>, <span class="math inline">\(E_{L + 1}(x) = x^{E_L(x)}\)</span>.</p>
<p>For geometric distributed offspring (corresponding to a negative Binomial with <span class="math inline">\(k=1\)</span>) this function is given by</p>
<p><span class="math display">\[
F(L) = \frac{ 1- R_0^{L + 1} } {1 - R_0^{L - 2}}
\]</span></p>
<p>In both cases <span class="math inline">\(f(L)\)</span> denotes cumulative mass functions and therefore the probability of observing a chain of length <span class="math inline">\(L\)</span> is therefore <span class="math inline">\(f(L) - f(L - 1)\)</span>.</p>
</div>
</div>
<div class="section level4">
<h4 id="gamma-borel-mixture">Gamma-Borel mixture<a class="anchor" aria-label="anchor" href="#gamma-borel-mixture"></a>
</h4>
<p>The probability distribution of outbreak sizes from a branching process with a Poisson offspring distribution (Eq. 2.2 in <span class="citation">Farrington, Kanaan, and Gay (<a href="#ref-farrington2003">2003</a>)</span>) is a special case of the <a href="https://en.wikipedia.org/wiki/Borel_distribution#Borel%E2%80%93Tanner_distribution" class="external-link">Borel-Tanner distribution</a> starting with 1 individual.
An alternative to the negative binomial offspring distribution which represents a Poisson-gamma mixture is a Borel-gamma mixture.
This could represent situations where the variation is not at the <em>individual level</em> but at the <em>chain level</em>, i.e. transmission chains is homogeneous but there is heterogeneity between chains.
In that case, it can be shown that the resulting log-likelihood of chain sizes is</p>
<p><span class="math display">\[\begin{align}
\mathrm{LL}(S) = &amp;\log\Gamma(k + S - 1) - \left(\log\Gamma(k) + \log\Gamma(S + 1) \right) \\
&amp; + (S-1) \log S - k \log \left(S + \frac{R_0}{k}\right)
\end{align}\]</span></p>
</div>
</div>
<div class="section level3">
<h3 id="numerical-approximations-of-chain-size-and-length-distributions">Numerical approximations of chain size and length distributions<a class="anchor" aria-label="anchor" href="#numerical-approximations-of-chain-size-and-length-distributions"></a>
</h3>
<p>When analytic likelihoods are not available a numerical approximation is used to derive the distributions.
In order to do this, the simulation functionality is be used to generate <span class="math inline">\(n\)</span> simulated chains and the value of the cumulative mass function <span class="math inline">\(P(S|\theta)\)</span> at the observed <span class="math inline">\(S\)</span> approximated by the empirical cumulative distribution function:
<span class="math display">\[
P(S|\theta) \approx \sum_i \mathbf{1}(x_i &lt;= S)
\]</span>
where <span class="math inline">\(\mathbf{1}\)</span> is the indicator function and <span class="math inline">\(x_i\)</span> the i-th observed chain size (or length, if the interest is in <span class="math inline">\(L\)</span>).
In order to improve this approximation a linear approximation is applied to the values of the empirical distribution function (at the expense of normalisation to 1).</p>
<p>The (unnormalised) probability of observing <span class="math inline">\(S\)</span> is then given by
<span class="math display">\[
p(S|\theta) = P(S|\theta) - P(S - 1|\theta)
\]</span>
and a an equivalent relationship is used for <span class="math inline">\(L\)</span>.</p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-blumberg2013" class="csl-entry">
Blumberg, S., and J. O. Lloyd-Smith. 2013. <span>“Comparing Methods for Estimating R0 from the Size Distribution of Subcritical Transmission Chains.”</span> <em>Epidemics</em> 5 (3): 131–45. <a href="https://doi.org/10.1016/j.epidem.2013.05.002" class="external-link">https://doi.org/10.1016/j.epidem.2013.05.002</a>.
</div>
<div id="ref-farrington2003" class="csl-entry">
Farrington, C. P., M. N. Kanaan, and N. J. Gay. 2003. <span>“Branching Process Models for Surveillance of Infectious Diseases Controlled by Mass Vaccination.”</span> <em>Biostatistics (Oxford, England)</em> 4 (2): 279–95. <a href="https://doi.org/10.1093/biostatistics/4.2.279" class="external-link">https://doi.org/10.1093/biostatistics/4.2.279</a>.
</div>
<div id="ref-lloyd-smith2005" class="csl-entry">
Lloyd-Smith, J. O., S. J. Schreiber, P. E. Kopp, and W. M. Getz. 2005. <span>“Superspreading and the Effect of Individual Variation on Disease Emergence.”</span> <em>Nature</em> 438 (7066): 355–59. <a href="https://doi.org/10.1038/nature04153" class="external-link">https://doi.org/10.1038/nature04153</a>.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James M. Azam, Flavio Finger, Sebastian Funk.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
